name: "Security Scanning"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '35 17 * * 0'

jobs:
  # 1. Code Scanning con CodeQL (anÃ¡lisis de cÃ³digo) exclude python
  codeql-analysis:
    name: CodeQL Analysis - Python
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Importante para detecciÃ³n precisa

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Debug - List Python files
        run: |
          echo "ðŸ“ Python files found:"
          find . -name "*.py" -not -path "./.*" | head -20 || echo "No .py files found"
          echo "ðŸ“ Requirements files:"
          find . -name "requirements.txt" -o -name "Pipfile" -o -name "pyproject.toml" | head -10

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: python # â¬…ï¸ SOLO Python
          queries: security-extended

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          output: sarif-results
        continue-on-error: true

  # 2. IaC Scanning con herramientas especializadas
  iac-scanning:
    name: Infrastructure as Code Scanning
    runs-on: ubuntu-latest
    needs: codeql-analysis
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run TfSec for Terraform
        uses: aquasecurity/tfsec-action@v0.1.0
        with:
          sarif_upload: true
        continue-on-error: true # No fallar el workflow completo por este paso

      - name: Run Checkov for multi-cloud IaC
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          output_format: sarif
          output_file: checkov-results.sarif
          soft_fail: true
        continue-on-error: true

      - name: Run Trivy for Kubernetes and Docker
        uses: aquasecurity/trivy-action@0.13.0
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload IaC Scan Results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: |
            tfsec-results.sarif
            checkov-results.sarif
            trivy-results.sarif

  # 3. Dependency Scanning (Dependabot ya funciona automÃ¡ticamente)
  dependency-scanning:
    name: Dependency Vulnerability Check
    runs-on: ubuntu-latest
    needs: codeql-analysis

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'my-project'
          path: '.'
          format: 'SARIF'
          out: 'dependency-check-results.sarif'
        continue-on-error: true

      - name: Upload Dependency Scan Results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: dependency-check-results.sarif

  # 4. Secret Scanning (se ejecuta automÃ¡ticamente pero podemos verificar)
  secret-scanning-check:
    name: Secret Scanning Verification
    runs-on: ubuntu-latest
    needs: [codeql-analysis, iac-scanning, dependency-scanning]
    if: always()

    steps:
      - name: Verify no new secrets detected
        run: |
          # Este paso verificarÃ­a mediante API si hay nuevas alertas de secretos
          # En la prÃ¡ctica, GitHub Secret Scanning funciona automÃ¡ticamente
          echo "âœ… Secret Scanning estÃ¡ activo automÃ¡ticamente en todo el repositorio"
          echo "Revisa la pestaÃ±a Security > Secret scanning alerts en tu repo"

  # 5. Resumen y reporte de resultados
  security-report:
    name: ðŸ“Š Security Scan Summary
    runs-on: ubuntu-latest
    needs: [codeql-analysis, iac-scanning, dependency-scanning, secret-scanning-check]
    if: always()

    steps:
      - name: Generate Security Summary
        run: |
          echo "ðŸš€ AnÃ¡lisis de seguridad completado"
          echo "--------------------------------"
          echo "âœ… Code Scanning - Completado"
          echo "âœ… IaC Scanning - Completado" 
          echo "âœ… Dependency Scanning - Completado"
          echo "âœ… Secret Scanning - Activado"
          echo ""
          echo "ðŸ“‹ Revisa los resultados en:"
          echo "   - PestaÃ±a 'Security' del repositorio"
          echo "   - GitHub Advanced Security alerts"
          echo "   - Actions logs para detalles completos"
